function extend(e,t){e.prototype=$.extend(e.prototype,new t),e.prototype.constructor=e}function eventTarget(){}function PngCut(e){var t=e||{};this.stage=$("#stage"),this.clip_img_wrap=$("#clip-img-wrap"),this.receiveImgData=null,this.cut_board=$(".cut_board"),this.start_cut_btn=$("#start-cut-btn"),this.protect_rect_btn=$(".protect-rect-btn"),this.fixed_range=$("#fixed_range"),this.curImgName=null,$.extend(this,t),this.init=function(){this.fixed_range.bind("change",function(){var e=$(this).val();e%2==1&&e++,$("#fixed_range_val").text(e+"px")})},this.init.call(this)}function img2Canvas(e){var t=document.createElement("canvas"),i=t.getContext("2d");return t.width=e.width,t.height=e.height,i.drawImage(e,0,0,e.width,e.height),$(e).before(t),funNav.removeThumb($(e).attr("sid")),$(e).remove(),t}function canvas2Img(e,t){var i=document.createElement("img");i.setAttribute("class","icon-img"),i.src=e.toDataURL("image/png"),t&&(i.src=t);var a=(1e5*Math.random()).toFixed(5);a>>=0;var n="sid"+a;i.setAttribute("sid",n),$(e).before(i),$(e).remove()}function setProtectRect(e){var t=e.getContext("2d");$(e).bind("mousedown",function(e){$(this).unbind("mousemove"),$(this).unbind("mouseup");var i=$(".protect-rect-btn").hasClass("active"),a=e.offsetX,n=e.offsetY;if(i){var r,c,o;$(this).bind("mousemove",function(e){r=e.offsetX-a,c=e.offsetY-n,o=t.createPattern(document.getElementById("img-pattern"),"repeat"),t.fillStyle=o,t.fillRect(a,n,r,c)}),$(this).bind("mouseup",function(){t.fillStyle="rgba(255,255,255,0.1)",t.fillRect(a,n,r,c),t.closePath(),$(this).unbind("mousemove")})}})}function watchActiveIconImg(){if(1==pc.clip_img_wrap.find(".icon-img.active").length&&0==pc.clip_img_wrap.find("canvas").length)pc.stage.addClass("working-cut-before"),pc.receiveImgData=pc.clip_img_wrap.find(".icon-img.active").attr("src");else{pc.stage.removeClass("working-cut-before");var e=pc.clip_img_wrap.find("canvas");$(".protect-rect-btn").removeClass("active"),1==e.length&&(canvas2Img(e.eq(0)[0],pc.receiveImgData),1==pc.clip_img_wrap.find(".icon-img.active").length&&0==pc.clip_img_wrap.find("canvas").length&&(pc.stage.addClass("working-cut-before"),pc.receiveImgData=pc.clip_img_wrap.find(".icon-img.active").attr("src")))}}function cutIconFromImg(e,t,i){function a(i){var a=!1;n.width=l,n.height=h;var c=document.createElement("img");c.setAttribute("src",t),r.drawImage(c,o,s,l,h,0,0,l,h);var d=document.createElement("div"),g=document.createElement("img"),m=document.createElement("div"),u=document.createElement("div"),p=document.createElement("span"),f=document.createElement("span"),v=document.createElement("span");d.setAttribute("class","icon-img-wrap"),g.src=n.toDataURL("image/png"),g.setAttribute("class","icon-img"),1==a&&g.setAttribute("class","icon-img modify");var w=(1e5*Math.random()).toFixed(5);w>>=0;var b="sid"+w+i;g.setAttribute("sid",b),m.setAttribute("class","icon-info"),m.innerHTML=l+"*"+h,f.setAttribute("class","icon-delete"),f.setAttribute("title","删除当前icon"),f.innerHTML="&#xe613;",v.setAttribute("class","icon-base64"),v.setAttribute("title","获取图base64"),v.innerHTML="base64",p.setAttribute("class","icon-download"),p.setAttribute("title","下载当前icon"),p.innerHTML="&#xe612;",u.setAttribute("class","icon-fun-board"),u.appendChild(f),u.appendChild(v),u.appendChild(p),d.appendChild(g),d.appendChild(m),d.appendChild(u),e.after(d)}util.hide_g_loading(),pc.stage.removeClass("working-cut-before");var n=document.createElement("canvas"),r=n.getContext("2d"),c=r.createImageData(1,1);c.data[0]=0,c.data[1]=0,c.data[2]=0,c.data[3]=0;for(var o=0,s=0,l=0,h=0,d=0;d<i.length;d++)o=i[d].left,s=i[d].top,l=i[d].right-i[d].left,h=i[d].bottom-i[d].top,a(d,i[d]);e.remove()}function downloadImg(e,t){function i(e){for(var t=atob(e.split(",")[1]),i=t.length,a=new Uint8Array(i),n=0;i>n;n++)a[n]=t.charCodeAt(n);var r=new Blob([a],{type:"image/png"});return r}function a(e){var t=document.createElement("a");e.attr("name")?t.setAttribute("download",e.attr("name")):t.setAttribute("download",r.name+ ++rank+".png"),t.href=URL.createObjectURL(i(e.attr("src"))),t.innerHTML="download",t.style.display="none",document.body.appendChild(t),t.click()}function n(e){var t=new JSZip,i=t.folder("icons");rank=0,e.each(function(){var e=$(this).attr("name"),t=$(this).attr("src"),a=t.substr(t.indexOf(",")+1);e?i.file(e,a,{base64:!0}):i.file(r.name+ ++rank+".png",a,{base64:!0})});var a=t.generate({type:"blob"});saveAs(a,r.reName+".zip")}var r={name:"icon",sizeType:"odd"};r=$.extend(r,t),1==e.length?a(e):e.length>1&&n(e)}function rgbToHsl(e,t,i){e/=255,t/=255,i/=255;var a,n,r=Math.max(e,t,i),c=Math.min(e,t,i),o=(r+c)/2;if(r==c)a=n=0;else{var s=r-c;switch(n=o>.5?s/(2-r-c):s/(r+c),r){case e:a=(t-i)/s+(i>t?6:0);break;case t:a=(i-e)/s+2;break;case i:a=(e-t)/s+4}a/=6}return[Math.round(360*a),Math.round(100*n),Math.round(100*o)]}function drawRoundedRect(e,t,i,a){var n=function(e,t){return{x:e,y:t}},r=n(e.x+t,e.y),c=n(e.x+e.width,e.y),o=n(e.x+e.width,e.y+e.height),s=n(e.x,e.y+e.height),l=n(e.x,e.y);i.beginPath(),i.moveTo(r.x,r.y),i.arcTo(c.x,c.y,o.x,o.y,t),i.arcTo(o.x,o.y,s.x,s.y,t),i.arcTo(s.x,s.y,l.x,l.y,t),i.arcTo(l.x,l.y,r.x,r.y,t),i.fillStyle=a,i.fill()}function drawTheme(e,t){function i(e,t,i,a){drawThemeCtx.beginPath(),drawThemeCtx.arc(e,t,i,0,2*Math.PI),drawThemeCtx.fillStyle=a,drawThemeCtx.fill(),drawThemeCtx.closePath()}var a=t.colorRgb(),n=rgbToHsl(a[0],a[1],a[2]),r=n[0],c=n[1],o=n[2];return window.drawThemeCanvans=window.drawThemeCanvans?window.drawThemeCanvans:document.createElement("canvas"),drawThemeCanvans.style.position="absolute",drawThemeCanvans.style.zIndex=1e3,drawThemeCanvans.width=480,drawThemeCanvans.height=82,window.drawThemeCtx=window.drawThemeCtx?window.drawThemeCtx:drawThemeCanvans.getContext("2d"),s=c,b=1.4*o,drawRoundedRect({x:0,y:0,width:480,height:82},41,drawThemeCtx,"hsl("+r+","+s+"%,"+b+"%)"),drawThemeCtx.globalCompositeOperation="source-atop",i(365,82,201,"hsl("+r+","+s+"%,"+b+"%)"),b=1.35*o,i(365,82,170,"hsl("+r+","+s+"%,"+b+"%)"),b=1.3*o,i(365,82,139,"hsl("+r+","+s+"%,"+b+"%)"),b=1.25*o,i(365,82,108,"hsl("+r+","+s+"%,"+b+"%)"),b=1.2*o,i(365,82,76,"hsl("+r+","+s+"%,"+b+"%)"),b=1.15*o,i(365,82,48,"hsl("+r+","+s+"%,"+b+"%)"),b=o,e&&drawThemeCtx.drawImage(e,180,0,300,82),drawThemeCanvans.toDataURL("image/png")}function clipfortheme_to_temple(e,t){t=t||"#999999";var i=e.attr("src");!e.eq(0)[0].getAttribute("origin")&&e.eq(0)[0].setAttribute("origin",i);var a=new Image;a.onload=function(){e.parent().parent().find(".icon-img").eq(0)[0].src=drawTheme(this,t)},a.src=e.eq(0)[0].getAttribute("origin")}function removeIcon(e){for(var t=0;t<e.length;t++){var i=e.eq(t).attr("sid");funNav.removeThumb(i),e.eq(t).parent().remove()}}function choise_icon(e){for(var t=0;t<e.length;t++){e.eq(t).addClass("active"),funNav.addThumb(e.eq(t).clone(!1));var i=e.eq(t).parent().find(".icon-info").text(),a=i.split("*")[0],n=i.split("*")[1];$(".resize-icon .w").val(a),$(".resize-icon .h").val(n)}watchActiveIconImg()}function unchoise_icon(e){for(var t=0;t<e.length;t++)e.eq(t).removeClass("active"),funNav.removeThumb(e.eq(t).attr("sid"));watchActiveIconImg()}function clipfortheme(){var e=$("#clip-img-wrap img"),t=void 0,i=300,a=0;e.each(function(){resizeImage($(this)[0],"scale",{origin:origin,width:i,height:t},function(){++a==e.length&&e.each(function(){resizeImage($(this)[0],"clip",{origin:"c_c",width:300,height:82}),console.log($(this)),clipfortheme_to_temple($(this))})})})}function compositeFrame(e){var t=$("#clip-img-wrap"),i=t.find("img");if(i.length<2)return alert("舞台上没有图片，或者少于2张"),!1;var a=0,n=0,r=document.createElement("canvas"),c=r.getContext("2d");if("v"==e){for(var o=0,s=i.length;s>o;o++)a=Math.max(a,i.eq(o)[0].naturalWidth),n+=i.eq(o)[0].naturalHeight;r.width=a,r.height=n;for(var l=0,o=0,s=i.length;s>o;o++)c.drawImage(i.eq(o)[0],0,l,i.eq(o)[0].width,i.eq(o)[0].height),l+=i.eq(o)[0].naturalHeight}else if("h"==e){for(var o=0,s=i.length;s>o;o++)a+=i.eq(o)[0].naturalWidth,n=i.eq(o)[0].naturalHeight>n?i.eq(o)[0].naturalHeight:n;r.width=a,r.height=n;for(var l=0,o=0,s=i.length;s>o;o++)c.drawImage(i.eq(o)[0],l,0,i.eq(o)[0].width,i.eq(o)[0].height),l+=i.eq(o)[0].naturalWidth}t.html(""),pc.receiveImg(r.toDataURL("image/png"))}function resizeImage(e,t,i,a){var i=i||{},n=i.width||e.width,r=i.height||e.height,c=i.origin||"c_c";tempImg=new Image;var o=document.createElement("canvas"),s=o.getContext("2d");tempImg.onload=function(){var l=0,h=0;if("clip"==t){switch(o.width=n,o.height=r,c){case"l_t":l=0,h=0;break;case"l_c":l=0,h=(o.height-e.height)/2;break;case"l_b":l=0,h=o.height-e.height;break;case"c_t":l=(o.width-e.width)/2,h=0;break;case"c_c":l=(o.width-e.width)/2,h=(o.height-e.height)/2;break;case"c_b":l=(o.width-e.width)/2,h=o.height-e.height;break;case"r_t":l=o.width-e.width,h=0;break;case"r_c":l=o.width-e.width,h=(o.height-e.height)/2;break;case"r_b":l=o.width-e.width,h=o.height-e.height}$(e).parent().find(".icon-info").text(o.width+"*"+o.height),s.drawImage(e,l,h,e.width,e.height),e.src=o.toDataURL("image/png")}else if("scale"==t){var d=i.width||i.height/this.height*this.width,g=i.height||i.width/this.width*this.height;d=Math.ceil(d),g=Math.ceil(g),$(e).parent().find(".icon-info").text(d+"*"+g),o.width=d,o.height=g,s.drawImage(e,l,h,d,g),e.src=o.toDataURL("image/png")}o=s=null,a&&a()},tempImg.src=e.getAttribute("src")}eventTarget.prototype={constructor:eventTarget,handler:function(e,t){"undefined"==typeof this.handlers&&(this.handlers={}),"undefined"==typeof this.handlers[e]&&(this.handlers[e]=new Array),this.handlers[e]=this.handlers[e].concat(t)},removeHandler:function(e,t){if("undefined"==typeof this.handlers&&(this.handlers={}),this.handlers[e]instanceof Array)for(var i=this.handlers[e],a=0,n=i.length;n>a;a++)if(t[a]==t){i.splice(a,1);break}},trigger:function(e){if("undefined"==typeof this.handlers&&(this.handlers={}),this.handlers[e]instanceof Array)for(var t=this.handlers[e],i=0,a=t.length;a>i;i++)t[i].call(this,this)}},PngCut.prototype={cut:function(e,t){var i=new Icon(e,this);i.getRectList(function(e){t&&t(e)})},receiveImg:function(e){this.receiveImgData=e,this.trigger("receiveImg")}},extend(PngCut,eventTarget);var pc=new PngCut,ttt=null;pc.handler("receiveImg",function(){pc.stage.addClass("working");var e=$("<img src='"+this.receiveImgData+"'/>")[0],t=document.createElement("div"),i=document.createElement("div"),a=document.createElement("div"),n=document.createElement("span"),r=document.createElement("input"),c=document.createElement("span");t.setAttribute("class","icon-img-wrap"),e.setAttribute("class","icon-img");var o=(1e5*Math.random()).toFixed(5);o>>=0;var s="sid"+o;e.setAttribute("sid",s),e.setAttribute("name",pc.curImgName),i.setAttribute("class","icon-info"),r.setAttribute("class","icon-base64"),r.setAttribute("type","color"),r.setAttribute("value","#614BFF"),n.setAttribute("class","icon-download"),n.setAttribute("title","下载当前icon"),n.innerHTML="&#xe612;",c.setAttribute("class","icon-delete"),c.setAttribute("title","删除当前icon"),c.innerHTML="&#xe613;",a.setAttribute("class","icon-fun-board"),a.appendChild(r),a.appendChild(c),a.appendChild(n),t.appendChild(e),t.appendChild(i),t.appendChild(a),clip_img_wrap.append(t),ttt&&clearTimeout(ttt),ttt=setTimeout(function(){clipfortheme()},300)}),$(".protect-rect-btn").bind("click",function(){if($(this).toggleClass("active"),$(this).hasClass("active")){var e=pc.clip_img_wrap.find(".icon-img.active").eq(0)[0],t=img2Canvas(e);$(t).css("cursor","crosshair"),setProtectRect(t)}else{var i=pc.clip_img_wrap.find("canvas").eq(0)[0];canvas2Img(i)}}),pc.start_cut_btn.bind("click",function(){});var stage=$("#stage"),clip_img_wrap=$("#clip-img-wrap");stage[0].addEventListener("dragenter",function(e){e.stopPropagation(),e.preventDefault()},!1),stage[0].addEventListener("dragover",function(e){e.stopPropagation(),e.preventDefault()},!1),stage[0].addEventListener("drop",function(e){function t(e){function t(i){var n=e[i];return i==e.length?!1:(a.onload=function(e){var a=e.srcElement.result;pc.curImgName=n.name,pc.receiveImg(a),t(++i)},a.readAsDataURL(n),void 0)}var i=0,a=new FileReader;t(i)}e.stopPropagation(),e.preventDefault(),t(e.dataTransfer.files)},!1);var pasteNum=0;window.addEventListener("paste",function(e){if(e.clipboardData&&e.clipboardData.items[0].type.indexOf("image")>-1){var t=new FileReader;file=e.clipboardData.items[0].getAsFile(),t.onload=function(e){var t=e.srcElement.result;pc.curImgName="paste"+pasteNum++ +".png",pc.receiveImg(t)},t.readAsDataURL(file)}},!1),$("#uploadImg").bind("change",function(e){var t=e.target.files[0],i=new FileReader;i.onload=function(e){var i=e.srcElement.result;pc.curImgName=t.name,pc.receiveImg(i)},i.readAsDataURL(t)});var rank=0;$("#icon-download-all").bind("click",function(){{var e=clip_img_wrap.find("img");$("#icon-name-before").val()}downloadImg(e,{name:$("#icon-name-before").val()})}),stage.on("click",".icon-download",function(){var e=$(this).parent().parent().find("img");downloadImg(e,{name:$("#icon-name-before").val()})}),String.prototype.colorRgb=function(){var e=this.toLowerCase(),t=/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/;if(e&&t.test(e)){if(4===e.length){for(var i="#",a=1;4>a;a+=1)i+=e.slice(a,a+1).concat(e.slice(a,a+1));e=i}for(var n=[],a=1;7>a;a+=2)n.push(parseInt("0x"+e.slice(a,a+2)));return n}},stage.on("change",".icon-base64",function(e){var t=$(this).parent().parent().find(".icon-img");clipfortheme_to_temple(t,e.target.value)}),stage.on("click",".icon-delete",function(){removeIcon($(this).parent().parent().find(".icon-img"))}),$("#help").bind("click",function(){alert("这里有一个简易帮助，待完善")}),$("#layout-row-button").on("click",function(){$(this).addClass("active").siblings().removeClass("active"),$("#clip-img-wrap").attr("class","")}),$("#layout-table-button").on("click",function(){$(this).addClass("active").siblings().removeClass("active"),$("#clip-img-wrap").attr("class","layout-table")}),$("#layout-rank-button").on("click",function(){$(this).addClass("active").siblings().removeClass("active"),$("#clip-img-wrap").attr("class","layout-rank");for(var e=[],t=0;t<$("#clip-img-wrap .icon-img-wrap").length;t++)e.push($("#clip-img-wrap .icon-img-wrap").eq(t).clone(!0));e.sort(function(e,t){return e.find(".icon-img").eq(0)[0].naturalWidth-t.find(".icon-img").eq(0)[0].naturalWidth}),e.reverse(),$("#clip-img-wrap").html("");for(var t=0;t<e.length;t++)$("#clip-img-wrap").append(e[t])}),funNav={removeThumb:function(e){$("#fun-board .nav ul").find("[sid="+e+"]").parent().remove(),this.refreshList()},addThumb:function(e){var t=e.attr("sid");if(0==$("#fun-board .nav ul").find("[sid="+t+"]").length){var i=$("<li>").append(e);$("#fun-board .nav ul").append(i),this.refreshList()}},refreshList:function(){var e=$("#fun-board .nav ul li").length,t=$("#fun-board .nav");9>=e?t.attr("class","nav num"+e):t.attr("class","nav numx")}},$("#clip-img-wrap").delegate(".icon-img","click",function(){var e=$(this).hasClass("active");1==e?unchoise_icon($(this)):choise_icon($(this))}),$(".cannel-choise").bind("click",function(){$("#clip-img-wrap").find(".icon-img.active").trigger("click")}),$(".all-choise").bind("click",function(){$("#clip-img-wrap").find(".icon-img").trigger("click")}),$(".input-number").bind("keyup",function(){var e=$(this).val(),t=e.replace(/\D/,"");e!=t&&$(this).val(t)}),$(".resize-icon-target li").bind("click",function(){$(this).addClass("active").siblings().html("").removeClass("active"),$(this).html("&#xe616;")}),$("#resize-icon-btn").bind("click",function(){var e=$("#clip-img-wrap img.active"),t=$(".resize-icon-target .active").attr("class").slice(7,10),i=$(".resize-icon .w").val(),a=$(".resize-icon .h").val();i=i.toString().replace(/\D/,""),a=a.toString().replace(/\D/,""),e.each(function(){resizeImage($(this)[0],"clip",{origin:t,width:i,height:a})})}),$("#resize-icon-scale").bind("click",function(){var e=$("#clip-img-wrap img.active"),t=$(".resize-icon .w").val(),i=$(".resize-icon .h").val();t=t.toString().replace(/\D/,""),i=i.toString().replace(/\D/,""),e.each(function(){resizeImage($(this)[0],"scale",{origin:origin,width:t,height:i})})}),$("#resize-icon-padding-btn").bind("click",function(){var e=$("#resize-icon-padding-val").val(),t=$("#clip-img-wrap img.active");return 0>e||e>5e3||0==t.length?!1:($("#resize-icon-padding-val").val(""),t.each(function(){w=$(this)[0].naturalWidth-0+2*e,h=$(this)[0].naturalHeight-0+2*e,$(this).parent().find(".icon-info").text(w+"*"+h),resizeImage($(this)[0],"clip",{origin:"c_c",width:w,height:h})}),void 0)}),$("#resize-icon-even").bind("click",function(){var e=$("#clip-img-wrap img");return 0==e.length?!1:(e.each(function(){w=$(this)[0].naturalWidth,h=$(this)[0].naturalHeight,w=w%2==1?++w:w,h=h%2==1?++h:h,$(this).parent().find(".icon-info").text(w+"*"+h),resizeImage($(this)[0],"clip",{origin:"c_c",width:w,height:h})}),void 0)}),$(".style-dialog .close").bind("click",function(){$(".style-dialog").removeClass("show")}),$("#get-style").bind("click",function(){function e(e){var t=$(e).attr("name").slice(0,$(e).attr("name").indexOf(".")),i=($(e).width()/100).toFixed(2),a=($(e).height()/100).toFixed(2);return[" ","."+t+"{","    width:"+i+"rem;","    height:"+a+"rem;","    background-image:url(../img/"+t+".png)","}"].join("\n")}var t=$(".style-dialog"),i=$("#clip-img-wrap").find("img[name]");if(0==i.length)alert("没有已命名的图片，请先上传后获取style");else{t.addClass("show");for(var a="",n="",r=0;r<i.length;r++)a+=e(i.eq(r)),n+="."+i.eq(r).attr("name").slice(0,i.eq(r).attr("name").indexOf("."))+"\n";t.find("textarea").val(a+"\n\n\n"+n)}}),$("#composite-frame-h").bind("click",function(){compositeFrame("v")}),$("#composite-frame-v").bind("click",function(){compositeFrame("h")});