function extend(e,t){e.prototype=$.extend(e.prototype,new t),e.prototype.constructor=e}function eventTarget(){}function PngCut(e){var t=e||{};this.stage=$("#stage"),this.clip_img_wrap=$("#clip-img-wrap"),this.receiveImgData=null,this.cut_board=$(".cut_board"),this.start_cut_btn=$("#start-cut-btn"),this.protect_rect_btn=$(".protect-rect-btn"),this.fixed_range=$("#fixed_range"),this.curImgName=null,$.extend(this,t),this.init=function(){this.fixed_range.bind("change",function(){var e=$(this).val();e%2==1&&e++,$("#fixed_range_val").text(e+"px")})},this.init.call(this)}function img2Canvas(e){var t=document.createElement("canvas"),i=t.getContext("2d");return t.width=e.width,t.height=e.height,i.drawImage(e,0,0,e.width,e.height),$(e).before(t),funNav.removeThumb($(e).attr("sid")),$(e).remove(),t}function canvas2Img(e,t){var i=document.createElement("img");i.setAttribute("class","icon-img"),i.src=e.toDataURL("image/png"),t&&(i.src=t);var n=(1e5*Math.random()).toFixed(5);n>>=0;var a="sid"+n;i.setAttribute("sid",a),$(e).before(i),$(e).remove()}function setProtectRect(e){var t=e.getContext("2d");$(e).bind("mousedown",function(e){$(this).unbind("mousemove"),$(this).unbind("mouseup");var i=$(".protect-rect-btn").hasClass("active"),n=e.offsetX,a=e.offsetY;if(i){var r,c,s;$(this).bind("mousemove",function(e){r=e.offsetX-n,c=e.offsetY-a,s=t.createPattern(document.getElementById("img-pattern"),"repeat"),t.fillStyle=s,t.fillRect(n,a,r,c)}),$(this).bind("mouseup",function(){t.fillStyle="rgba(255,255,255,0.1)",t.fillRect(n,a,r,c),t.closePath(),$(this).unbind("mousemove")})}})}function watchActiveIconImg(){if(1==pc.clip_img_wrap.find(".icon-img.active").length&&0==pc.clip_img_wrap.find("canvas").length)pc.stage.addClass("working-cut-before"),pc.receiveImgData=pc.clip_img_wrap.find(".icon-img.active").attr("src");else{pc.stage.removeClass("working-cut-before");var e=pc.clip_img_wrap.find("canvas");$(".protect-rect-btn").removeClass("active"),1==e.length&&(canvas2Img(e.eq(0)[0],pc.receiveImgData),1==pc.clip_img_wrap.find(".icon-img.active").length&&0==pc.clip_img_wrap.find("canvas").length&&(pc.stage.addClass("working-cut-before"),pc.receiveImgData=pc.clip_img_wrap.find(".icon-img.active").attr("src")))}}function cutIconFromImg(e,t,i){function n(i){var n=!1;a.width=l,a.height=d;var c=document.createElement("img");c.setAttribute("src",t),r.drawImage(c,s,o,l,d,0,0,l,d);var g=document.createElement("div"),h=document.createElement("img"),m=document.createElement("div"),p=document.createElement("div"),u=document.createElement("span"),v=document.createElement("span"),f=document.createElement("span");g.setAttribute("class","icon-img-wrap"),h.src=a.toDataURL("image/png"),h.setAttribute("class","icon-img"),1==n&&h.setAttribute("class","icon-img modify");var b=(1e5*Math.random()).toFixed(5);b>>=0;var w="sid"+b+i;h.setAttribute("sid",w),m.setAttribute("class","icon-info"),m.innerHTML=l+"*"+d,v.setAttribute("class","icon-delete"),v.setAttribute("title","删除当前icon"),v.innerHTML="&#xe613;",f.setAttribute("class","icon-base64"),f.setAttribute("title","获取图base64"),f.innerHTML="base64",u.setAttribute("class","icon-download"),u.setAttribute("title","下载当前icon"),u.innerHTML="&#xe612;",p.setAttribute("class","icon-fun-board"),p.appendChild(v),p.appendChild(f),p.appendChild(u),g.appendChild(h),g.appendChild(m),g.appendChild(p),e.after(g)}util.hide_g_loading(),pc.stage.removeClass("working-cut-before");var a=document.createElement("canvas"),r=a.getContext("2d"),c=r.createImageData(1,1);c.data[0]=0,c.data[1]=0,c.data[2]=0,c.data[3]=0;for(var s=0,o=0,l=0,d=0,g=0;g<i.length;g++)s=i[g].left,o=i[g].top,l=i[g].right-i[g].left,d=i[g].bottom-i[g].top,n(g,i[g]);e.remove()}function downloadImg(e,t){function i(e){var t=document.createElement("a");e.attr("name")?t.setAttribute("download",e.attr("name")):t.setAttribute("download",a.name+ ++rank+".png"),t.href=e.attr("src"),t.innerHTML="download",t.style.display="none",document.body.appendChild(t),t.click()}function n(e){var t=new JSZip,i=t.folder("icons");rank=0,e.each(function(){var e=$(this).attr("name"),t=$(this).attr("src"),n=t.substr(t.indexOf(",")+1);e?i.file(e,n,{base64:!0}):i.file(a.name+ ++rank+".png",n,{base64:!0})});var n=t.generate({type:"blob"});saveAs(n,a.reName+".zip")}var a={name:"icon",sizeType:"odd"};a=$.extend(a,t),1==e.length?i(e):e.length>1&&n(e)}function removeIcon(e){for(var t=0;t<e.length;t++){var i=e.eq(t).attr("sid");funNav.removeThumb(i),e.eq(t).parent().remove()}}function choise_icon(e){for(var t=0;t<e.length;t++){e.eq(t).addClass("active"),funNav.addThumb(e.eq(t).clone(!1));var i=e.eq(t).parent().find(".icon-info").text(),n=i.split("*")[0],a=i.split("*")[1];$(".resize-icon .w").val(n),$(".resize-icon .h").val(a)}watchActiveIconImg()}function unchoise_icon(e){for(var t=0;t<e.length;t++)e.eq(t).removeClass("active"),funNav.removeThumb(e.eq(t).attr("sid"));watchActiveIconImg()}function compositeFrame(){var e=$("#clip-img-wrap"),t=e.find("img");if(t.length<2)return alert("舞台上没有图片，或者少于2张"),!1;for(var i=0,n=0,a=0,r=t.length;r>a;a++)i+=t.eq(a)[0].naturalWidth,n=t.eq(a)[0].naturalHeight>n?t.eq(a)[0].naturalHeight:n;var c=document.createElement("canvas"),s=c.getContext("2d");c.width=i,c.height=n;for(var o=0,a=0,r=t.length;r>a;a++)s.drawImage(t.eq(a)[0],o,0,t.eq(a)[0].width,t.eq(a)[0].height),o+=t.eq(a)[0].naturalWidth;e.html(""),pc.receiveImg(c.toDataURL("image/png")),console.dir(pc.clip_img_wrap.find("img"))}function resizeImage(e,t){var t=t||{},i=t.width||e.width,n=t.height||e.width,a=t.origin||"c_c";tempImg=new Image,tempImg.onload=function(){var t=document.createElement("canvas"),r=t.getContext("2d");t.width=i,t.height=n;var c=0,s=0;switch(a){case"l_t":c=0,s=0;break;case"l_c":c=0,s=(t.height-e.height)/2;break;case"l_b":c=0,s=t.height-e.height;break;case"c_t":c=(t.width-e.width)/2,s=0;break;case"c_c":c=(t.width-e.width)/2,s=(t.height-e.height)/2;break;case"c_b":c=(t.width-e.width)/2,s=t.height-e.height;break;case"r_t":c=t.width-e.width,s=0;break;case"r_c":c=t.width-e.width,s=(t.height-e.height)/2;break;case"r_b":c=t.width-e.width,s=t.height-e.height}r.drawImage(e,c,s,e.width,e.height),e.src=t.toDataURL("image/png")},tempImg.src=e.getAttribute("src")}eventTarget.prototype={constructor:eventTarget,handler:function(e,t){"undefined"==typeof this.handlers&&(this.handlers={}),"undefined"==typeof this.handlers[e]&&(this.handlers[e]=new Array),this.handlers[e]=this.handlers[e].concat(t)},removeHandler:function(e,t){if("undefined"==typeof this.handlers&&(this.handlers={}),this.handlers[e]instanceof Array)for(var i=this.handlers[e],n=0,a=i.length;a>n;n++)if(t[n]==t){i.splice(n,1);break}},trigger:function(e){if("undefined"==typeof this.handlers&&(this.handlers={}),this.handlers[e]instanceof Array)for(var t=this.handlers[e],i=0,n=t.length;n>i;i++)t[i].call(this,this)}},PngCut.prototype={cut:function(e,t){var i=new Icon(e,this);i.getRectList(function(e){t&&t(e)})},receiveImg:function(e){this.receiveImgData=e,this.trigger("receiveImg")}},extend(PngCut,eventTarget);var pc=new PngCut;pc.handler("receiveImg",function(){pc.stage.addClass("working");var e=$("<img src='"+this.receiveImgData+"'/>")[0],t=document.createElement("div"),i=document.createElement("div"),n=document.createElement("div"),a=document.createElement("span"),r=document.createElement("span"),c=document.createElement("span");t.setAttribute("class","icon-img-wrap"),e.setAttribute("class","icon-img");var s=(1e5*Math.random()).toFixed(5);s>>=0;var o="sid"+s;e.setAttribute("sid",o),e.setAttribute("name",pc.curImgName),i.setAttribute("class","icon-info"),setTimeout(function(){i.innerHTML=e.naturalWidth+"*"+e.naturalHeight},100),r.setAttribute("class","icon-base64"),r.setAttribute("title","获取图base64"),r.innerHTML="base64",a.setAttribute("class","icon-download"),a.setAttribute("title","下载当前icon"),a.innerHTML="&#xe612;",c.setAttribute("class","icon-delete"),c.setAttribute("title","删除当前icon"),c.innerHTML="&#xe613;",n.setAttribute("class","icon-fun-board"),n.appendChild(a),n.appendChild(r),n.appendChild(c),t.appendChild(e),t.appendChild(i),t.appendChild(n),clip_img_wrap.append(t)}),$(".protect-rect-btn").bind("click",function(){if($(this).toggleClass("active"),$(this).hasClass("active")){var e=pc.clip_img_wrap.find(".icon-img.active").eq(0)[0],t=img2Canvas(e);$(t).css("cursor","crosshair"),setProtectRect(t)}else{var i=pc.clip_img_wrap.find("canvas").eq(0)[0];canvas2Img(i)}}),pc.start_cut_btn.bind("click",function(){pc.protect_rect_btn.hasClass("active")&&pc.protect_rect_btn.trigger("click");var e=pc.clip_img_wrap.find("canvas").eq(0).parent(),t=pc.clip_img_wrap.find(".icon-img.active").eq(0).parent(),i=1==e.length?e:t;pc.clip_img_wrap.find("img").eq(0).hasClass("active")&&pc.clip_img_wrap.find("img").eq(0).trigger("click");var n=i.find("img").eq(0).attr("src"),a=pc.receiveImgData,r=pc.fixed_range.val();util.show_g_loading();var c=new Icon(n,{fixed:Math.round(r/2)});c.init(function(){cutIconFromImg(i,a,this.boxes,"clip-img-wrap")})});var stage=$("#stage"),clip_img_wrap=$("#clip-img-wrap");stage[0].addEventListener("dragenter",function(e){e.stopPropagation(),e.preventDefault()},!1),stage[0].addEventListener("dragover",function(e){e.stopPropagation(),e.preventDefault()},!1),stage[0].addEventListener("drop",function(e){function t(e){function t(i){var a=e[i];return i==e.length?!1:(n.onload=function(e){var n=e.srcElement.result;pc.curImgName=a.name,pc.receiveImg(n),t(++i)},n.readAsDataURL(a),void 0)}var i=0,n=new FileReader;t(i)}e.stopPropagation(),e.preventDefault(),t(e.dataTransfer.files)},!1),stage[0].addEventListener("paste",function(e){if(e.clipboardData&&e.clipboardData.items[0].type.indexOf("image")>-1){var t=new FileReader;file=e.clipboardData.items[0].getAsFile(),t.onload=function(e){var t=e.srcElement.result;pc.curImgName="paste",pc.receiveImg(t)},t.readAsDataURL(file)}},!1),$("#uploadImg").bind("change",function(e){var t=e.target.files[0],i=new FileReader;i.onload=function(e){var i=e.srcElement.result;pc.curImgName=t.name,pc.receiveImg(i)},i.readAsDataURL(t)});var rank=0;$("#icon-download-all").bind("click",function(){{var e=clip_img_wrap.find("img");$("#icon-name-before").val()}downloadImg(e,{name:$("#icon-name-before").val()})}),stage.on("click",".icon-download",function(){var e=$(this).parent().parent().find("img");downloadImg(e,{name:$("#icon-name-before").val()})}),stage.on("click",".icon-base64",function(){var e=$(this).parent().parent().find(".icon-img").attr("src"),t=document.createElement("textarea");t.value=e,t.style.height="0",document.body.appendChild(t),t.select();try{var i=document.execCommand("copy"),n=i?"已经复制到粘贴板":"获取失败";alert(n)}catch(a){console.log("获取失败")}$(t).remove()}),stage.on("click",".icon-delete",function(){removeIcon($(this).parent().parent().find(".icon-img"))}),$("#help").bind("click",function(){alert("这里有一个简易帮助，待完善")}),$("#layout-row-button").on("click",function(){$(this).addClass("active").siblings().removeClass("active"),$("#clip-img-wrap").attr("class","")}),$("#layout-table-button").on("click",function(){$(this).addClass("active").siblings().removeClass("active"),$("#clip-img-wrap").attr("class","layout-table")}),$("#layout-rank-button").on("click",function(){$(this).addClass("active").siblings().removeClass("active"),$("#clip-img-wrap").attr("class","layout-rank");for(var e=[],t=0;t<$("#clip-img-wrap .icon-img-wrap").length;t++)e.push($("#clip-img-wrap .icon-img-wrap").eq(t).clone(!0));e.sort(function(e,t){return e.find(".icon-img").eq(0)[0].naturalWidth-t.find(".icon-img").eq(0)[0].naturalWidth}),e.reverse(),$("#clip-img-wrap").html("");for(var t=0;t<e.length;t++)$("#clip-img-wrap").append(e[t])}),funNav={removeThumb:function(e){$("#fun-board .nav ul").find("[sid="+e+"]").parent().remove(),this.refreshList()},addThumb:function(e){var t=e.attr("sid");if(0==$("#fun-board .nav ul").find("[sid="+t+"]").length){var i=$("<li>").append(e);$("#fun-board .nav ul").append(i),this.refreshList()}},refreshList:function(){var e=$("#fun-board .nav ul li").length,t=$("#fun-board .nav");9>=e?t.attr("class","nav num"+e):t.attr("class","nav numx")}},$("#clip-img-wrap").delegate(".icon-img","click",function(){var e=$(this).hasClass("active");1==e?unchoise_icon($(this)):choise_icon($(this))}),$(".cannel-choise").bind("click",function(){$("#clip-img-wrap").find(".icon-img.active").trigger("click")}),$(".all-choise").bind("click",function(){$("#clip-img-wrap").find(".icon-img").trigger("click")}),$(".input-number").bind("keyup",function(){var e=$(this).val(),t=e.replace(/\D/,"");e!=t&&$(this).val(t)}),$(".resize-icon-target li").bind("click",function(){$(this).addClass("active").siblings().html("").removeClass("active"),$(this).html("&#xe616;")}),$("#resize-icon-btn").bind("click",function(){var e=$("#clip-img-wrap img.active"),t=$(".resize-icon-target .active").attr("class").slice(7,10),i=$(".resize-icon .w").val(),n=$(".resize-icon .h").val();i=i.toString().replace(/\D/,""),n=n.toString().replace(/\D/,""),e.each(function(){$(this).parent().find(".icon-info").text(i+"*"+n),resizeImage($(this)[0],{origin:t,width:i,height:n})})}),$("#resize-icon-padding-btn").bind("click",function(){var e=$("#resize-icon-padding-val").val(),t=$("#clip-img-wrap img.active");return 0>e||e>5e3||0==t.length?!1:($("#resize-icon-padding-val").val(""),t.each(function(){w=$(this)[0].naturalWidth-0+2*e,h=$(this)[0].naturalHeight-0+2*e,$(this).parent().find(".icon-info").text(w+"*"+h),resizeImage($(this)[0],{origin:"c_c",width:w,height:h})}),void 0)}),$("#resize-icon-even").bind("click",function(){var e=$("#clip-img-wrap img");return 0==e.length?!1:(e.each(function(){w=$(this)[0].naturalWidth,h=$(this)[0].naturalHeight,w=w%2==1?++w:w,h=h%2==1?++h:h,$(this).parent().find(".icon-info").text(w+"*"+h),resizeImage($(this)[0],{origin:"c_c",width:w,height:h})}),void 0)}),$(".style-dialog .close").bind("click",function(){$(".style-dialog").removeClass("show")}),$("#get-style").bind("click",function(){function e(e){var t=$(e).attr("name").slice(0,$(e).attr("name").indexOf(".")),i=($(e).width()/100).toFixed(2),n=($(e).height()/100).toFixed(2);return[" ","."+t+"{","    width:"+i+"rem;","    height:"+n+"rem;","    background-image:url(../img/"+t+".png)","}"].join("\n")}var t=$(".style-dialog"),i=$("#clip-img-wrap").find("img[name]");if(0==i.length)alert("没有已命名的图片，请先上传后获取style");else{t.addClass("show");for(var n="",a="",r=0;r<i.length;r++)n+=e(i.eq(r)),a+="."+i.eq(r).attr("name").slice(0,i.eq(r).attr("name").indexOf("."))+"\n";t.find("textarea").val(n+"\n\n\n"+a)}}),$("#composite-frame").bind("click",function(){compositeFrame()});