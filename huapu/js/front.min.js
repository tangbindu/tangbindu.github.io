function extend(subType,superType){subType.prototype=$.extend(subType.prototype,new superType),subType.prototype.constructor=subType}function eventTarget(){}function PngCut(config){var conf=config||{};this.stage=$("#stage"),this.clip_img_wrap=$("#clip-img-wrap"),this.receiveImgData=null,this.cut_board=$(".cut_board"),this.start_cut_btn=$("#start-cut-btn"),this.protect_rect_btn=$(".protect-rect-btn"),this.fixed_range=$("#fixed_range"),this.curImgName=null,$.extend(this,conf),this.init=function(){this.fixed_range.bind("change",function(){var val=$(this).val();val%2==1&&val++,$("#fixed_range_val").text(val+"px")})},this.init.call(this)}function img2Canvas(img){var canvas=document.createElement("canvas"),ctx=canvas.getContext("2d");return canvas.width=img.width,canvas.height=img.height,ctx.drawImage(img,0,0,img.width,img.height),$(img).before(canvas),funNav.removeThumb($(img).attr("sid")),$(img).remove(),canvas}function canvas2Img(cvs,data){var img=document.createElement("img");img.setAttribute("class","icon-img"),img.src=cvs.toDataURL("image/png"),data&&(img.src=data);var ram=(1e5*Math.random()).toFixed(5);ram>>=0;var sid="sid"+ram;img.setAttribute("sid",sid),$(cvs).before(img),$(cvs).remove()}function setProtectRect(canvas){var ctx=canvas.getContext("2d");$(canvas).bind("mousedown",function(event){$(this).unbind("mousemove"),$(this).unbind("mouseup");var hasActive=$(".protect-rect-btn").hasClass("active"),x=event.offsetX,y=event.offsetY;if(hasActive){var width,height,pat;$(this).bind("mousemove",function(event){width=event.offsetX-x,height=event.offsetY-y,pat=ctx.createPattern(document.getElementById("img-pattern"),"repeat"),ctx.fillStyle=pat,ctx.fillRect(x,y,width,height)}),$(this).bind("mouseup",function(){ctx.fillStyle="rgba(255,255,255,0.1)",ctx.fillRect(x,y,width,height),ctx.closePath(),$(this).unbind("mousemove")})}})}function watchActiveIconImg(){if(1==pc.clip_img_wrap.find(".icon-img.active").length&&0==pc.clip_img_wrap.find("canvas").length)pc.stage.addClass("working-cut-before"),pc.receiveImgData=pc.clip_img_wrap.find(".icon-img.active").attr("src");else{pc.stage.removeClass("working-cut-before");var cvs=pc.clip_img_wrap.find("canvas");$(".protect-rect-btn").removeClass("active"),1==cvs.length&&(canvas2Img(cvs.eq(0)[0],pc.receiveImgData),1==pc.clip_img_wrap.find(".icon-img.active").length&&0==pc.clip_img_wrap.find("canvas").length&&(pc.stage.addClass("working-cut-before"),pc.receiveImgData=pc.clip_img_wrap.find(".icon-img.active").attr("src")))}}function cutIconFromImg(icon_wrap,img,boxes){function cut(i){var modify=!1;canvas.width=width,canvas.height=height;var imgNode=document.createElement("img");imgNode.setAttribute("src",img),ctx.drawImage(imgNode,left,top,width,height,0,0,width,height);var icon_img_wrap=document.createElement("div"),icon_img=document.createElement("img"),icon_img_info=document.createElement("div"),icon_fun_board=document.createElement("div"),icon_img_download=document.createElement("span"),icon_img_delete=document.createElement("span"),icon_img_base64=document.createElement("span");icon_img_wrap.setAttribute("class","icon-img-wrap"),icon_img.src=canvas.toDataURL("image/png"),icon_img.setAttribute("class","icon-img"),1==modify&&icon_img.setAttribute("class","icon-img modify");var ram=(1e5*Math.random()).toFixed(5);ram>>=0;var sid="sid"+ram+i;icon_img.setAttribute("sid",sid),icon_img_info.setAttribute("class","icon-info"),icon_img_info.innerHTML=width+"*"+height,icon_img_delete.setAttribute("class","icon-delete"),icon_img_delete.setAttribute("title","删除当前icon"),icon_img_delete.innerHTML="&#xe613;",icon_img_base64.setAttribute("class","icon-base64"),icon_img_base64.setAttribute("title","获取图base64"),icon_img_base64.innerHTML="base64",icon_img_download.setAttribute("class","icon-download"),icon_img_download.setAttribute("title","下载当前icon"),icon_img_download.innerHTML="&#xe612;",icon_fun_board.setAttribute("class","icon-fun-board"),icon_fun_board.appendChild(icon_img_delete),icon_fun_board.appendChild(icon_img_base64),icon_fun_board.appendChild(icon_img_download),icon_img_wrap.appendChild(icon_img),icon_img_wrap.appendChild(icon_img_info),icon_img_wrap.appendChild(icon_fun_board),icon_wrap.after(icon_img_wrap)}util.hide_g_loading(),pc.stage.removeClass("working-cut-before");var canvas=document.createElement("canvas"),ctx=canvas.getContext("2d"),imgDa=ctx.createImageData(1,1);imgDa.data[0]=0,imgDa.data[1]=0,imgDa.data[2]=0,imgDa.data[3]=0;for(var left=0,top=0,width=0,height=0,i=0;i<boxes.length;i++)left=boxes[i].left,top=boxes[i].top,width=boxes[i].right-boxes[i].left,height=boxes[i].bottom-boxes[i].top,cut(i,boxes[i]);icon_wrap.remove()}function downloadImg(imglist,param){function download(imglist){var a=document.createElement("a");imglist.attr("name")?a.setAttribute("download",imglist.attr("name")):a.setAttribute("download",conf.name+ ++rank+".png"),a.href=imglist.attr("src"),a.innerHTML="download",a.style.display="none",document.body.appendChild(a),a.click()}function zipdownload(imglist){var zip=new JSZip,img=zip.folder("icons");rank=0,imglist.each(function(){var name=$(this).attr("name"),src=$(this).attr("src"),imgData=src.substr(src.indexOf(",")+1);name?img.file(name,imgData,{base64:!0}):img.file(conf.name+ ++rank+".png",imgData,{base64:!0})});var content=zip.generate({type:"blob"});saveAs(content,conf.reName+".zip")}var conf={name:"icon",sizeType:"odd"};conf=$.extend(conf,param),1==imglist.length?download(imglist):imglist.length>1&&zipdownload(imglist)}function removeIcon(icon_img){for(var i=0;i<icon_img.length;i++){var sid=icon_img.eq(i).attr("sid");funNav.removeThumb(sid),icon_img.eq(i).parent().remove()}}function choise_icon(icon_img){for(var i=0;i<icon_img.length;i++){icon_img.eq(i).addClass("active"),funNav.addThumb(icon_img.eq(i).clone(!1));var size=icon_img.eq(i).parent().find(".icon-info").text(),size_w=size.split("*")[0],size_h=size.split("*")[1];$(".resize-icon .w").val(size_w),$(".resize-icon .h").val(size_h)}watchActiveIconImg()}function unchoise_icon(icon_img){for(var i=0;i<icon_img.length;i++)icon_img.eq(i).removeClass("active"),funNav.removeThumb(icon_img.eq(i).attr("sid"));watchActiveIconImg()}function compositeFrame(){var clipImgWrap=$("#clip-img-wrap"),imgs=clipImgWrap.find("img");if(imgs.length<2)return alert("舞台上没有图片，或者少于2张"),!1;for(var compositeFrameWidth=0,compositeFrameHeight=0,i=0,il=imgs.length;il>i;i++)compositeFrameWidth+=imgs.eq(i)[0].naturalWidth,compositeFrameHeight=imgs.eq(i)[0].naturalHeight>compositeFrameHeight?imgs.eq(i)[0].naturalHeight:compositeFrameHeight;var canvas=document.createElement("canvas"),ctx=canvas.getContext("2d");canvas.width=compositeFrameWidth,canvas.height=compositeFrameHeight;for(var imgloc=0,i=0,il=imgs.length;il>i;i++)ctx.drawImage(imgs.eq(i)[0],imgloc,0,imgs.eq(i)[0].width,imgs.eq(i)[0].height),imgloc+=imgs.eq(i)[0].naturalWidth;clipImgWrap.html(""),pc.receiveImg(canvas.toDataURL("image/png")),console.dir(pc.clip_img_wrap.find("img"))}function resizeImage(img,param){var param=param||{},new_width=param.width||img.width,new_height=param.height||img.width,origin=param.origin||"c_c";tempImg=new Image,tempImg.onload=function(){var canvas=document.createElement("canvas"),ctx=canvas.getContext("2d");canvas.width=new_width,canvas.height=new_height;var x=0,y=0;switch(origin){case"l_t":x=0,y=0;break;case"l_c":x=0,y=(canvas.height-img.height)/2;break;case"l_b":x=0,y=canvas.height-img.height;break;case"c_t":x=(canvas.width-img.width)/2,y=0;break;case"c_c":x=(canvas.width-img.width)/2,y=(canvas.height-img.height)/2;break;case"c_b":x=(canvas.width-img.width)/2,y=canvas.height-img.height;break;case"r_t":x=canvas.width-img.width,y=0;break;case"r_c":x=canvas.width-img.width,y=(canvas.height-img.height)/2;break;case"r_b":x=canvas.width-img.width,y=canvas.height-img.height}ctx.drawImage(img,x,y,img.width,img.height),img.src=canvas.toDataURL("image/png")},tempImg.src=img.getAttribute("src")}eventTarget.prototype={constructor:eventTarget,handler:function(type,handler){"undefined"==typeof this.handlers&&(this.handlers={}),"undefined"==typeof this.handlers[type]&&(this.handlers[type]=new Array),this.handlers[type]=this.handlers[type].concat(handler)},removeHandler:function(type,handler){if("undefined"==typeof this.handlers&&(this.handlers={}),this.handlers[type]instanceof Array)for(var handlers=this.handlers[type],i=0,len=handlers.length;len>i;i++)if(handler[i]==handler){handlers.splice(i,1);break}},trigger:function(type){if("undefined"==typeof this.handlers&&(this.handlers={}),this.handlers[type]instanceof Array)for(var handlers=this.handlers[type],i=0,len=handlers.length;len>i;i++)handlers[i].call(this,this)}},PngCut.prototype={cut:function(imgData,callback){var ico=new Icon(imgData,this);ico.getRectList(function(list){callback&&callback(list)})},receiveImg:function(imgData){this.receiveImgData=imgData,this.trigger("receiveImg")}},extend(PngCut,eventTarget);var pc=new PngCut;pc.handler("receiveImg",function(){pc.stage.addClass("working");var icon_img=$("<img src='"+this.receiveImgData+"'/>")[0],icon_img_wrap=document.createElement("div"),icon_img_info=document.createElement("div"),icon_fun_board=document.createElement("div"),icon_img_download=document.createElement("span"),icon_img_base64=document.createElement("span"),icon_img_delete=document.createElement("span");icon_img_wrap.setAttribute("class","icon-img-wrap"),icon_img.setAttribute("class","icon-img");var ram=(1e5*Math.random()).toFixed(5);ram>>=0;var sid="sid"+ram;icon_img.setAttribute("sid",sid),icon_img.setAttribute("name",pc.curImgName),icon_img_info.setAttribute("class","icon-info"),setTimeout(function(){icon_img_info.innerHTML=icon_img.naturalWidth+"*"+icon_img.naturalHeight},100),icon_img_base64.setAttribute("class","icon-base64"),icon_img_base64.setAttribute("title","获取图base64"),icon_img_base64.innerHTML="base64",icon_img_download.setAttribute("class","icon-download"),icon_img_download.setAttribute("title","下载当前icon"),icon_img_download.innerHTML="&#xe612;",icon_img_delete.setAttribute("class","icon-delete"),icon_img_delete.setAttribute("title","删除当前icon"),icon_img_delete.innerHTML="&#xe613;",icon_fun_board.setAttribute("class","icon-fun-board"),icon_fun_board.appendChild(icon_img_download),icon_fun_board.appendChild(icon_img_base64),icon_fun_board.appendChild(icon_img_delete),icon_img_wrap.appendChild(icon_img),icon_img_wrap.appendChild(icon_img_info),icon_img_wrap.appendChild(icon_fun_board),clip_img_wrap.append(icon_img_wrap)}),$(".protect-rect-btn").bind("click",function(){if($(this).toggleClass("active"),$(this).hasClass("active")){var img=pc.clip_img_wrap.find(".icon-img.active").eq(0)[0],cvs=img2Canvas(img);$(cvs).css("cursor","crosshair"),setProtectRect(cvs)}else{var canvas=pc.clip_img_wrap.find("canvas").eq(0)[0];canvas2Img(canvas)}}),pc.start_cut_btn.bind("click",function(){pc.protect_rect_btn.hasClass("active")&&pc.protect_rect_btn.trigger("click");var cp=pc.clip_img_wrap.find("canvas").eq(0).parent(),ip=pc.clip_img_wrap.find(".icon-img.active").eq(0).parent(),icon_wrap=1==cp.length?cp:ip;pc.clip_img_wrap.find("img").eq(0).hasClass("active")&&pc.clip_img_wrap.find("img").eq(0).trigger("click");var imgData=icon_wrap.find("img").eq(0).attr("src"),originImg=pc.receiveImgData,fixed=pc.fixed_range.val();util.show_g_loading();var ico=new Icon(imgData,{fixed:Math.round(fixed/2)});ico.init(function(){cutIconFromImg(icon_wrap,originImg,this.boxes,"clip-img-wrap")})});var stage=$("#stage"),clip_img_wrap=$("#clip-img-wrap");stage[0].addEventListener("dragenter",function(e){e.stopPropagation(),e.preventDefault()},!1),stage[0].addEventListener("dragover",function(e){e.stopPropagation(),e.preventDefault()},!1),stage[0].addEventListener("drop",function(e){function handleFile(files){function readerFiles(i){var file=files[i];return i==files.length?!1:(reader.onload=function(theFile){var imgData=theFile.srcElement.result;pc.curImgName=file.name,pc.receiveImg(imgData),readerFiles(++i)},reader.readAsDataURL(file),void 0)}var i=0,reader=new FileReader;readerFiles(i)}e.stopPropagation(),e.preventDefault(),handleFile(e.dataTransfer.files)},!1),$("#uploadImg").bind("change",function(event){var file=event.target.files[0],reader=new FileReader;reader.onload=function(theFile){var imgData=theFile.srcElement.result;pc.curImgName=file.name,pc.receiveImg(imgData)},reader.readAsDataURL(file)});var rank=0;$("#icon-download-all").bind("click",function(){{var imglist=clip_img_wrap.find("img");$("#icon-name-before").val()}downloadImg(imglist,{name:$("#icon-name-before").val()})}),stage.on("click",".icon-download",function(){var img=$(this).parent().parent().find("img");downloadImg(img,{name:$("#icon-name-before").val()})}),stage.on("click",".icon-base64",function(){var base64=$(this).parent().parent().find(".icon-img").attr("src"),copyTextarea=document.createElement("textarea");copyTextarea.value=base64,copyTextarea.style.height="0",document.body.appendChild(copyTextarea),copyTextarea.select();try{var successful=document.execCommand("copy"),msg=successful?"已经复制到粘贴板":"获取失败";alert(msg)}catch(err){console.log("获取失败")}$(copyTextarea).remove()}),stage.on("click",".icon-delete",function(){removeIcon($(this).parent().parent().find(".icon-img"))}),$("#help").bind("click",function(){alert("这里有一个简易帮助，待完善")}),$("#layout-row-button").on("click",function(){$(this).addClass("active").siblings().removeClass("active"),$("#clip-img-wrap").attr("class","")}),$("#layout-table-button").on("click",function(){$(this).addClass("active").siblings().removeClass("active"),$("#clip-img-wrap").attr("class","layout-table")}),$("#layout-rank-button").on("click",function(){$(this).addClass("active").siblings().removeClass("active"),$("#clip-img-wrap").attr("class","layout-rank");for(var icon_arr=[],i=0;i<$("#clip-img-wrap .icon-img-wrap").length;i++)icon_arr.push($("#clip-img-wrap .icon-img-wrap").eq(i).clone(!0));icon_arr.sort(function(a,b){return a.find(".icon-img").eq(0)[0].naturalWidth-b.find(".icon-img").eq(0)[0].naturalWidth}),icon_arr.reverse(),$("#clip-img-wrap").html("");for(var i=0;i<icon_arr.length;i++)$("#clip-img-wrap").append(icon_arr[i])}),funNav={removeThumb:function(sid){$("#fun-board .nav ul").find("[sid="+sid+"]").parent().remove(),this.refreshList()},addThumb:function(img){var sid=img.attr("sid");if(0==$("#fun-board .nav ul").find("[sid="+sid+"]").length){var li=$("<li>").append(img);$("#fun-board .nav ul").append(li),this.refreshList()}},refreshList:function(){var length=$("#fun-board .nav ul li").length,nav=$("#fun-board .nav");9>=length?nav.attr("class","nav num"+length):nav.attr("class","nav numx")}},$("#clip-img-wrap").delegate(".icon-img","click",function(){var hasActive=$(this).hasClass("active");1==hasActive?unchoise_icon($(this)):choise_icon($(this))}),$(".cannel-choise").bind("click",function(){$("#clip-img-wrap").find(".icon-img.active").trigger("click")}),$(".all-choise").bind("click",function(){$("#clip-img-wrap").find(".icon-img").trigger("click")}),$(".input-number").bind("keyup",function(){var val=$(this).val(),newval=val.replace(/\D/,"");val!=newval&&$(this).val(newval)}),$(".resize-icon-target li").bind("click",function(){$(this).addClass("active").siblings().html("").removeClass("active"),$(this).html("&#xe616;")}),$("#resize-icon-btn").bind("click",function(){var resize_Images=$("#clip-img-wrap img.active"),origin=$(".resize-icon-target .active").attr("class").slice(7,10),w=$(".resize-icon .w").val(),h=$(".resize-icon .h").val();w=w.toString().replace(/\D/,""),h=h.toString().replace(/\D/,""),resize_Images.each(function(){$(this).parent().find(".icon-info").text(w+"*"+h),resizeImage($(this)[0],{origin:origin,width:w,height:h})})}),$("#resize-icon-padding-btn").bind("click",function(){var padding=$("#resize-icon-padding-val").val(),resize_Images=$("#clip-img-wrap img.active");return 0>padding||padding>5e3||0==resize_Images.length?!1:($("#resize-icon-padding-val").val(""),resize_Images.each(function(){w=$(this)[0].naturalWidth-0+2*padding,h=$(this)[0].naturalHeight-0+2*padding,$(this).parent().find(".icon-info").text(w+"*"+h),resizeImage($(this)[0],{origin:"c_c",width:w,height:h})}),void 0)}),$("#resize-icon-even").bind("click",function(){var resize_Images=$("#clip-img-wrap img");return 0==resize_Images.length?!1:(resize_Images.each(function(){w=$(this)[0].naturalWidth,h=$(this)[0].naturalHeight,w=w%2==1?++w:w,h=h%2==1?++h:h,$(this).parent().find(".icon-info").text(w+"*"+h),resizeImage($(this)[0],{origin:"c_c",width:w,height:h})}),void 0)}),$(".style-dialog .close").bind("click",function(){$(".style-dialog").removeClass("show")}),$("#get-style").bind("click",function(){function showstyle(img){var name=$(img).attr("name").slice(0,$(img).attr("name").indexOf(".")),width=($(img).width()/100).toFixed(2),height=($(img).height()/100).toFixed(2);return[" ","."+name+"{","    width:"+width+"rem;","    height:"+height+"rem;","    background-image:url(../img/"+name+".png)","}"].join("\n")}var styledialog=$(".style-dialog"),imgs=$("#clip-img-wrap").find("img[name]");if(0==imgs.length)alert("没有已命名的图片，请先上传后获取style");else{styledialog.addClass("show");for(var styles="",names="",i=0;i<imgs.length;i++)styles+=showstyle(imgs.eq(i)),names+="."+imgs.eq(i).attr("name").slice(0,imgs.eq(i).attr("name").indexOf("."))+"\n";styledialog.find("textarea").val(styles+"\n\n\n"+names)}}),$("#composite-frame").bind("click",function(){compositeFrame()});