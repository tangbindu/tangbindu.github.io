function findIcon(cvs,piex2D,fixed){function recursion(point,flagNum){var top={x:point.x,y:point.y-1},right={x:point.x+1,y:point.y},bottom={x:point.x,y:point.y+1},left={x:point.x-1,y:point.y},top_left={x:point.x-1,y:point.y-1},top_right={x:point.x+1,y:point.y-1},bottom_left={x:point.x-1,y:point.y+1},bottom_right={x:point.x+1,y:point.y+1};try{var top_val=piex2D[top.y][top.x];2==top_val&&(piex2D[top.y][top.x]=flagNum,recursion(top,flagNum))}catch(event){}try{var right_val=piex2D[right.y][right.x];2==right_val&&(piex2D[right.y][right.x]=flagNum,recursion(right,flagNum))}catch(event){}try{var bottom_val=piex2D[bottom.y][bottom.x];2==bottom_val&&(piex2D[bottom.y][bottom.x]=flagNum,recursion(bottom,flagNum))}catch(event){}try{var left_val=piex2D[left.y][left.x];2==left_val&&(piex2D[left.y][left.x]=flagNum,recursion(left,flagNum))}catch(event){}try{var top_left_val=piex2D[top_left.y][top_left.x];2==top_left_val&&(piex2D[top_left.y][top_left.x]=flagNum,recursion(top_left,flagNum))}catch(event){}try{var top_right_val=piex2D[top_right.y][top_right.x];2==top_right_val&&(piex2D[top_right.y][top_right.x]=flagNum,recursion(top_right,flagNum))}catch(event){}try{var bottom_left_val=piex2D[bottom_left.y][bottom_left.x];2==bottom_left_val&&(piex2D[bottom_left.y][bottom_left.x]=flagNum,recursion(bottom_left,flagNum))}catch(event){}try{var bottom_right_val=piex2D[bottom_right.y][bottom_right.x];2==bottom_right_val&&(piex2D[bottom_right.y][bottom_right.x]=flagNum,recursion(bottom_right,flagNum))}catch(event){}}function findIconBox(num){var points=[],box={top:0,right:0,bottom:0,left:0,data:null,flag:num};for(y=0;y<cvs.height;y++)for(x=0;x<cvs.width;x++)piex2D[y][x]==num&&points.push({y:y,x:x});return points.sort(function(a,b){return a.x-b.x}),box.left=points[0].x,box.right=points[points.length-1].x+1-2*fixed,points.sort(function(a,b){return a.y-b.y}),box.top=points[0].y,box.bottom=points[points.length-1].y+1-2*fixed,box.data=getPart2d(piex2D,box),box}{var flag=2;cvs.width,cvs.height}for(time=0,y=0;y<piex2D.length;y++)for(x=0;x<piex2D[y].length;x++){{0==piex2D[y][x-1]?!0:!1}2!=piex2D[y][x]||piex2D[y][x-1]?2==piex2D[y][x]&&piex2D[y][x-1]&&(piex2D[y][x]=1,recursion({x:x,y:y},1)):(piex2D[y][x]=++flag,recursion({x:x,y:y},flag))}for(var iconBoxes=[],i=3;flag>=i;i++)iconBoxes.push(findIconBox(i));return iconBoxes}function getPart2d(piex2D,box){var part=[];for(y=box.top;y<box.bottom;y++){var row=[];for(x=box.left;x<box.right;x++)row.push(piex2D[y][x]);part.push(row)}return part}function findBorder(map2d){for(var circle=[],i=0;i<map2d.length;i++)for(var j=0;j<map2d[i].length;j++)if(1==map2d[i][j]){try{circle[0]=map2d[i-1][j-1]}catch(err){circle[0]=0}try{circle[1]=map2d[i][j-1]}catch(err){circle[1]=0}try{circle[2]=map2d[i+1][j-1]}catch(err){circle[2]=0}try{circle[3]=map2d[i-1][j]}catch(err){circle[3]=0}try{circle[4]=map2d[i+1][j]}catch(err){circle[4]=0}try{circle[5]=map2d[i-1][j+1]}catch(err){circle[5]=0}try{circle[6]=map2d[i][j+1]}catch(err){circle[6]=0}try{circle[7]=map2d[i+1][j+1]}catch(err){circle[7]=0}for(var z=0;z<circle.length;z++)if(0==circle[z]||void 0==circle[z]){map2d[i][j]=2;break}}}function biggerIcon(map2d,fixed){function bigger(i,j){for(var y=-1*fixed;fixed>=y;y++)for(var x=-1*fixed;fixed>=x;x++)2!=map2d[i-0+y][j-0+x]&&(map2d[i-0+y][j-0+x]=1)}for(var i=0;i<map2d.length;i++)for(var j=0;j<map2d[i].length;j++)2==map2d[i][j]&&bigger(i,j);for(var i=0;i<map2d.length;i++)for(var j=0;j<map2d[i].length;j++)2==map2d[i][j]&&(map2d[i][j]=1)}function Icon(imgData,param){this.imgData=imgData,this.piex2D=[],this.img=null,this.width=null,this.height=null,this.piex=null,this.fixed=10,this.boxes=[],this.canvas=null;$.extend(this,param)}util={show2D:function(data){for(var y=0;y<data.length;y++){for(var xlist="",x=0;x<data[y].length;x++)xlist+=data[y][x]+"";xlist+="list"+y,console.log(xlist)}},show_g_loading:function(){$("#stage").addClass("g-loading-show")},hide_g_loading:function(){$("#stage").removeClass("g-loading-show")},isChrome:function(){var ua=navigator.userAgent,reg=new RegExp("chrome","i");0==reg.test(ua)&&(document.body.style["background-color"]="black",document.body.innerHTML="",setTimeout(function(){alert("亲，请使用chrome浏览器玩耍哦！")},1e3))}},util.isChrome(),Icon.prototype={init:function(callback){var ctx,self=this;self.img=new Image,self.img.onload=function(){self.width=self.img.width,self.height=self.img.height,self.canvas=document.createElement("canvas"),ctx=self.canvas.getContext("2d"),self.canvas.width=self.width+2*self.fixed,self.canvas.height=self.height+2*self.fixed;(new Date).getTime();ctx.drawImage(self.img,self.fixed,self.fixed,self.width,self.height),self.piex=ctx.getImageData(0,0,self.canvas.width,self.canvas.height).data,self.piexTo2D(),findBorder(self.piex2D),biggerIcon(self.piex2D,self.fixed),findBorder(self.piex2D),self.boxes=findIcon(self.canvas,self.piex2D,self.fixed),callback&&callback.call(self)},self.img.src=this.imgData},piexTo2D:function(){var i=0,j=0,z=0,mapArr=[];for(i;i<this.piex.length;i+=4){var r=this.piex[i],g=this.piex[i+1],b=this.piex[i+2],a=this.piex[i+3];mapArr[j++]=this.isPiex(r,g,b,a)?1:0}for(y=0;y<this.canvas.height;y++)for(this.piex2D[y]=[],x=0;x<this.canvas.width;x++){var cur=mapArr[z++];this.piex2D[y][x]=cur}},isPiex:function(r,g,b,a){return r|g|b|a}};